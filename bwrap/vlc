#!/bin/bash
SCRIPT=$(realpath -P -- "${BASH_SOURCE[0]}")
source "${SCRIPT%/*}/lib.sh"

mkdir -m 0700 -p ~/.config/vlc ~/.local/share/vlc

FLAGS=(
  ${X11_FLAGS[@]}
  #--ro-bind-try "${XDG_RUNTIME_DIR}/bus" "${XDG_RUNTIME_DIR}/bus"
  --ro-bind-try "${XDG_RUNTIME_DIR}/pulse" "${XDG_RUNTIME_DIR}/pulse"
  --ro-bind-try "${XDG_RUNTIME_DIR}/pipewire-0" "${XDG_RUNTIME_DIR}/pipewire-0"
  --bind-try ~/.config/vlc ~/.config/vlc
  --bind-try ~/.local/share/vlc ~/.local/share/vlc
  --ro-bind /usr/bin/vlc /usr/bin/vlc
  --ro-bind-try ~/.config/dconf ~/.config/dconf
  --unsetenv SESSION_MANAGER
)
add_gpu

for arg in "$@"; do
  if [[ "$arg" =~ ^https?://.* ]]; then
    FLAGS+=(--share-net)
  elif [[ -f "$arg" ]]; then
    FLAGS+=(--ro-bind "$(realpath "$arg")"  "$(realpath "$arg")")
    if [[ -f "$arg.srt" ]]; then
      FLAGS+=(--ro-bind "$(realpath "$arg.srt")"  "$(realpath "$arg.srt")")
    fi
  fi
done

bwrap "${FLAGS[@]}" /usr/bin/vlc "$@"
exit $?
